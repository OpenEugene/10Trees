@using OpenEug.TenTrees.Module.Village.Services

@namespace OpenEug.TenTrees.Module.Village
@inherits ModuleBase
@inject IVillageService VillageService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<Edit> Localizer

<div class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <form @ref="form" class="@(validated ? " was-validated" : "needs-validation")" novalidate>
                <div class="row mb-3 align-items-center">
                    <Label Class="col-sm-4" For="villageName" HelpText="Enter the village name" ResourceKey="VillageName">Village Name: </Label>
                    <div class="col-sm-8">
                        <input id="villageName" type="text" class="form-control" @bind="@_village.VillageName" required />
                        <div class="invalid-feedback">@Localizer["Validation.VillageNameRequired"]</div>
                    </div>
                </div>
                <div class="row mb-3 align-items-center">
                    <Label Class="col-sm-4" For="contactName" HelpText="Enter the primary contact name" ResourceKey="ContactName">Contact Name: </Label>
                    <div class="col-sm-8">
                        <input id="contactName" type="text" class="form-control" @bind="@_village.ContactName" />
                    </div>
                </div>
                <div class="row mb-3 align-items-center">
                    <Label Class="col-sm-4" For="contactPhone" HelpText="Enter the contact phone number" ResourceKey="ContactPhone">Contact Phone: </Label>
                    <div class="col-sm-8">
                        <input id="contactPhone" type="tel" class="form-control" @bind="@_village.ContactPhone" />
                    </div>
                </div>
                <div class="row mb-3 align-items-center">
                    <Label Class="col-sm-4" For="contactEmail" HelpText="Enter the contact email address" ResourceKey="ContactEmail">Contact Email: </Label>
                    <div class="col-sm-8">
                        <input id="contactEmail" type="email" class="form-control" @bind="@_village.ContactEmail" />
                        <div class="invalid-feedback">@Localizer["Validation.EmailInvalid"]</div>
                    </div>
                </div>
                <div class="row mb-3 align-items-center">
                    <Label Class="col-sm-4" For="notes" HelpText="Additional notes about the village" ResourceKey="Notes">Notes: </Label>
                    <div class="col-sm-8">
                        <textarea id="notes" class="form-control" @bind="@_village.Notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="row mb-3 align-items-center">
                    <Label Class="col-sm-4" For="isActive" HelpText="Is this village currently active?" ResourceKey="IsActive">Active: </Label>
                    <div class="col-sm-8">
                        <input id="isActive" type="checkbox" @bind="@_village.IsActive" />
                    </div>
                </div>
            </form>

            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-success" @onclick="Save">@Localizer["Save"]</button>
                <NavLink class="btn btn-secondary" href="@NavigateUrl()">@Localizer["Cancel"]</NavLink>
            </div>
            
            @if (PageState.Action == "Edit")
            {
                <AuditInfo CreatedBy="@_village.CreatedBy" CreatedOn="@_village.CreatedOn" ModifiedBy="@_village.ModifiedBy" ModifiedOn="@_village.ModifiedOn"></AuditInfo>
            }
        </div>
    </div>
</div>

@code {
public override string Actions => "Add,Edit";
public override string Title => "Manage Village";
public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Admin;
public override bool UseAdminContainer => false;

    private ElementReference form;
    private bool validated = false;
    private Models.Village _village = new Models.Village { IsActive = true };

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (PageState.Action == "Edit")
            {
                int villageId = Int32.Parse(PageState.QueryString["id"]);
                _village = await VillageService.GetVillageAsync(villageId);
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Loading Village {VillageId} {Error}", PageState.QueryString["id"], ex.Message);
            AddModuleMessage(Localizer["Message.LoadError"], MessageType.Error);
        }
    }

    private async Task Save()
    {
        try
        {
            validated = true;
            var interop = new Oqtane.UI.Interop(JSRuntime);
            if (await interop.FormValid(form))
            {
                if (PageState.Action == "Edit")
                {
                    _village = await VillageService.UpdateVillageAsync(_village);
                    await logger.LogInformation("Village Updated {Village}", _village.VillageName);
                }
                else
                {
                    _village = await VillageService.AddVillageAsync(_village);
                    await logger.LogInformation("Village Added {Village}", _village.VillageName);
                }
                
                AddModuleMessage(Localizer["Message.SaveSuccess"], MessageType.Success);
                NavigationManager.NavigateTo(NavigateUrl());
            }
            else
            {
                AddModuleMessage(Localizer["Message.ValidationError"], MessageType.Error);
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Saving Village {Village} {Error}", _village.VillageName, ex.Message);
            AddModuleMessage(Localizer["Message.SaveError"], MessageType.Error);
        }
    }
}
