@using OpenEug.TenTrees.Module.Enrollment.Services
@using Oqtane.Modules.Controls

@namespace OpenEug.TenTrees.Module.Enrollment
@inherits ModuleBase
@inject IEnrollmentService EnrollmentService
@inject IEnrollmentStateService StateService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<Signature> Localizer

<div class="mb-3">
    <h3 class="mb-2">@Localizer["FormTitle"]</h3>
    <p class="text-muted small">@Localizer["Step"] 4 @Localizer["Of"] 4</p>
</div>

<div class="progress mb-3" style="height: 8px;">
    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
</div>

<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">@Localizer["Section.Signature"]</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> @Localizer["Signature.Info"]
        </div>
        
        <div class="mb-3">
            <Label For="signature" ResourceKey="Signature" Class="form-label fw-bold">Signature: *</Label>
            <textarea id="signature" class="form-control form-control-lg" @bind="@_signatureData" rows="4" 
                      placeholder="@Localizer["Signature.Placeholder"]" required style="font-size: 18px;"></textarea>
            <small class="form-text text-muted">@Localizer["Signature.Help"]</small>
        </div>

        <div class="form-check p-3 border rounded">
            <input class="form-check-input" type="checkbox" id="confirm" @bind="@_confirmed" required style="width: 24px; height: 24px;" />
            <label class="form-check-label ms-2 fw-bold" for="confirm">
                @Localizer["Signature.Confirm"]
            </label>
        </div>
    </div>
</div>

<!-- Summary Card -->
<div class="card mb-3">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">@Localizer["Summary"]</h5>
    </div>
    <div class="card-body">
        <div class="mb-2">
            <strong>@Localizer["GrowerName"]:</strong><br />
            <span class="fs-5">@StateService.CurrentDraft?.GrowerName</span>
        </div>
        <div class="mb-2">
            <strong>@Localizer["Village"]:</strong><br />
            <span class="fs-5">@StateService.CurrentDraft?.VillageId</span>
        </div>
        <div class="mb-2">
            <strong>@Localizer["HouseholdSize"]:</strong><br />
            <span class="fs-5">@StateService.CurrentDraft?.HouseholdSize</span>
        </div>
    </div>
</div>

@if (_isSaving)
{
    <div class="alert alert-info text-center">
        <div class="spinner-border spinner-border-lg" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">@Localizer["Saving"]</div>
    </div>
}

<div class="d-grid gap-2 mb-3">
    <button type="button" class="btn btn-success btn-lg" @onclick="Submit" disabled="@(!_confirmed || _isSaving)">
        <i class="bi bi-check-circle"></i> @Localizer["Submit"]
    </button>
    <button type="button" class="btn btn-outline-secondary" @onclick="PreviousStep" disabled="@_isSaving">
        <i class="bi bi-arrow-left"></i> @Localizer["Previous"]
    </button>
</div>

@code {
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Edit;
    public override string Actions => "Signature";
    public override string Title => "Enrollment - Signature";

    private string _signatureData;
    private bool _confirmed;
    private bool _isSaving;

    protected override void OnInitialized()
    {
        if (StateService.CurrentDraft == null)
        {
            NavigationManager.NavigateTo(EditUrl("BasicInfo"));
            return;
        }

        // Restore from draft
        _signatureData = StateService.CurrentDraft.SignatureData;
    }

    private void PreviousStep()
    {
        StateService.CurrentDraft.SignatureData = _signatureData;
        NavigationManager.NavigateTo(EditUrl("Commitments"));
    }

    private async Task Submit()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_signatureData) || !_confirmed)
            {
                AddModuleMessage(Localizer["Message.ValidationError"], MessageType.Error);
                return;
            }

            _isSaving = true;
            StateHasChanged();

            // Create enrollment from draft
            var enrollment = new Models.Enrollment
            {
                ModuleId = ModuleState.ModuleId,
                
                // Basic Information
                GrowerName = StateService.CurrentDraft.GrowerName,
                VillageId = StateService.CurrentDraft.VillageId,
                HouseNumber = StateService.CurrentDraft.HouseNumber,
                IdNumber = StateService.CurrentDraft.IdNumber,
                BirthDate = StateService.CurrentDraft.BirthDate,
                HouseholdSize = StateService.CurrentDraft.HouseholdSize,
                OwnsHome = StateService.CurrentDraft.OwnsHome,
                EnrollmentDate = DateTime.UtcNow,
                MentorId = PageState.User.UserId,
                TreeMentorName = StateService.CurrentDraft.TreeMentorName,
                
                // Preferred Criteria
                EnrolledInPE = StateService.CurrentDraft.EnrolledInPE,
                PEGraduate = StateService.CurrentDraft.PEGraduate,
                GardenPlantedAndTended = StateService.CurrentDraft.GardenPlantedAndTended,
                ChildHeadedHousehold = StateService.CurrentDraft.ChildHeadedHousehold,
                WomanHeadedHousehold = StateService.CurrentDraft.WomanHeadedHousehold,
                EmptyYard = StateService.CurrentDraft.EmptyYard,
                
                // Commitments
                CommitNoChemicals = StateService.CurrentDraft.CommitNoChemicals,
                CommitAttendClasses = StateService.CurrentDraft.CommitAttendClasses,
                CommitNoCuttingTrees = StateService.CurrentDraft.CommitNoCuttingTrees,
                CommitStandForWomenChildren = StateService.CurrentDraft.CommitStandForWomenChildren,
                CommitCareWhileAway = StateService.CurrentDraft.CommitCareWhileAway,
                CommitAllowYardAccess = StateService.CurrentDraft.CommitAllowYardAccess,
                
                // Signature
                SignatureData = _signatureData,
                SignatureCollected = true,
                SignatureDate = DateTime.UtcNow,
                
                Status = Models.EnrollmentStatus.Pending
            };

            var result = await EnrollmentService.AddEnrollmentAsync(enrollment);
            await logger.LogInformation("Enrollment Added {Enrollment}", result);

            // Clear draft
            StateService.ClearDraft();

            // Show success and navigate
            AddModuleMessage(Localizer["Message.Success"], MessageType.Success);
            NavigationManager.NavigateTo(NavigateUrl());
        }
        catch (Exception ex)
        {
            _isSaving = false;
            await logger.LogError(ex, "Error Saving Enrollment {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.Error"], MessageType.Error);
        }
    }
}
