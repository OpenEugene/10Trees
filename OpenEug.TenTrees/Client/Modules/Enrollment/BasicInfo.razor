@using OpenEug.TenTrees.Module.Enrollment.Services
@using OpenEug.TenTrees.Module.Enrollment.Models
@using Oqtane.Modules.Controls

@namespace OpenEug.TenTrees.Module.Enrollment
@inherits ModuleBase
@inject IEnrollmentService EnrollmentService
@inject IEnrollmentStateService StateService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<BasicInfo> Localizer

<div class="container">
    <h3>@Localizer["FormTitle"]</h3>
    <p class="text-muted">@Localizer["Step"] 1 @Localizer["Of"] 4</p>
    
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
    </div>

    <form @ref="form" class="@(validated ? " was-validated" : "needs-validation" )" novalidate>
        <div class="card mb-3">
            <div class="card-header">
                <h5>@Localizer["Section.BasicInfo"]</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="evaluatorname" ResourceKey="EvaluatorName">Evaluator Name:</Label>
                    <div class="col-sm-8">
                        <input id="evaluatorname" class="form-control" @bind="@_evaluatorName" readonly />
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="beneficiaryname" ResourceKey="BeneficiaryName">Beneficiary Name: *</Label>
                    <div class="col-sm-8">
                        <input id="beneficiaryname" class="form-control" @bind="@_beneficiaryName" required />
                        <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="villageid" ResourceKey="Village">Village: *</Label>
                    <div class="col-sm-8">
                        <input id="villageid" type="number" class="form-control" @bind="@_villageId" required />
                        <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="housenumber" ResourceKey="HouseNumber">House Number:</Label>
                    <div class="col-sm-8">
                        <input id="housenumber" class="form-control" @bind="@_houseNumber" />
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="idnumber" ResourceKey="IdNumber">ID Number:</Label>
                    <div class="col-sm-8">
                        <input id="idnumber" class="form-control" @bind="@_idNumber" />
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="birthdate" ResourceKey="BirthDate">Birth Date:</Label>
                    <div class="col-sm-8">
                        <input id="birthdate" type="date" class="form-control" @bind="@_birthDate" />
                        <small class="form-text text-muted">@Localizer["BirthDate.Help"]</small>
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="ownshome" ResourceKey="OwnsHome">Do they own their home?</Label>
                    <div class="col-sm-8">
                        <select id="ownshome" class="form-select" @bind="@_ownsHome">
                            <option value="">@Localizer["Select"]</option>
                            <option value="true">@Localizer["Yes"]</option>
                            <option value="false">@Localizer["No"]</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="householdsize" ResourceKey="HouseholdSize">Household Size: *</Label>
                    <div class="col-sm-8">
                        <input id="householdsize" type="number" class="form-control" @bind="@_householdSize" required min="1" />
                        <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
                    </div>
                </div>
                <div class="row mb-3">
                    <Label Class="col-sm-4" For="enrollmentdate" ResourceKey="Date">Date:</Label>
                    <div class="col-sm-8">
                        <input id="enrollmentdate" type="date" class="form-control" @bind="@_enrollmentDate" readonly />
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between">
            <NavLink class="btn btn-secondary" href="@NavigateUrl()">@Localizer["Cancel"]</NavLink>
            <button type="button" class="btn btn-primary" @onclick="NextStep">
                @Localizer["Next"] <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </form>
</div>

@code {
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Edit;
    public override string Actions => "BasicInfo";
    public override string Title => "Enrollment - Basic Information";

    private ElementReference form;
    private bool validated = false;

    private string _evaluatorName;
    private string _beneficiaryName;
    private int _villageId;
    private string _houseNumber;
    private string _idNumber;
    private DateTime? _birthDate;
    private bool _ownsHome;
    private int _householdSize = 1;
    private DateTime _enrollmentDate = DateTime.Today;

    protected override void OnInitialized()
    {
        _evaluatorName = PageState.User.DisplayName;
        
        // Initialize or restore draft
        if (StateService.CurrentDraft == null)
        {
            StateService.InitializeDraft(ModuleState.ModuleId);
        }
        else
        {
            // Restore from draft
            _evaluatorName = StateService.CurrentDraft.EvaluatorName ?? PageState.User.DisplayName;
            _beneficiaryName = StateService.CurrentDraft.BeneficiaryName;
            _villageId = StateService.CurrentDraft.VillageId;
            _houseNumber = StateService.CurrentDraft.HouseNumber;
            _idNumber = StateService.CurrentDraft.IdNumber;
            _birthDate = StateService.CurrentDraft.BirthDate;
            _ownsHome = StateService.CurrentDraft.OwnsHome;
            _householdSize = StateService.CurrentDraft.HouseholdSize;
        }
    }

    private async Task NextStep()
    {
        try
        {
            validated = true;
            var interop = new Oqtane.UI.Interop(JSRuntime);
            if (await interop.FormValid(form))
            {
                // Save to draft state
                StateService.CurrentDraft.EvaluatorName = _evaluatorName;
                StateService.CurrentDraft.BeneficiaryName = _beneficiaryName;
                StateService.CurrentDraft.VillageId = _villageId;
                StateService.CurrentDraft.HouseNumber = _houseNumber;
                StateService.CurrentDraft.IdNumber = _idNumber;
                StateService.CurrentDraft.BirthDate = _birthDate;
                StateService.CurrentDraft.OwnsHome = _ownsHome;
                StateService.CurrentDraft.HouseholdSize = _householdSize;

                // Navigate to next step
                NavigationManager.NavigateTo(EditUrl("Criteria"));
            }
            else
            {
                AddModuleMessage(Localizer["Message.Validation"], MessageType.Warning);
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error in BasicInfo step {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.Error"], MessageType.Error);
        }
    }
}
