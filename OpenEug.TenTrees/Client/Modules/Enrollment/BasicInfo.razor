@using OpenEug.TenTrees.Module.Enrollment.Services
@using OpenEug.TenTrees.Module.Village.Services
@using Oqtane.Modules.Controls

@namespace OpenEug.TenTrees.Module.Enrollment
@inherits ModuleBase
@inject IEnrollmentService EnrollmentService
@inject IVillageService VillageService
@inject IEnrollmentStateService StateService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<BasicInfo> Localizer

<div class="container">
    <div class="mb-3">
        <h3 class="mb-2">@Localizer["FormTitle"]</h3>
        <p class="text-muted small">@Localizer["Step"] 1 @Localizer["Of"] 4</p>
    </div>

    <div class="progress mb-3" style="height: 8px;">
        <div class="progress-bar" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

<form @ref="form" class="@(validated ? " was-validated" : "needs-validation" )" novalidate>
    <div class="row">
        <!-- Card 1: Participant Information -->
        <div class="col-12 col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">@Localizer["Section.ParticipantInfo"]</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <Label For="treementorname" ResourceKey="TreeMentorName" ResourceType="@resourceType" Class="form-label fw-bold">Tree Mentor Name:</Label>
                        <input id="treementorname" class="form-control form-control-lg" @bind="@_treeMentorName" readonly />
                    </div>
                    
                    <div class="mb-3">
                        <Label For="growername" ResourceKey="GrowerName" ResourceType="@resourceType" Class="form-label fw-bold">Grower Name: *</Label>
                        <input id="growername" class="form-control form-control-lg" @bind="@_growerName" required />
                        <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
                    </div>
                    
                    <div class="mb-3">
                        <Label For="villageid" ResourceKey="Village" ResourceType="@resourceType" Class="form-label fw-bold">Village: *</Label>
                        <select id="villageid" class="form-select form-select-lg" @bind="@_villageId" required>
                            <option value="0">@Localizer["Select"]</option>
                            @if (_villages != null)
                            {
                                @foreach (var village in _villages.Where(v => v.IsActive))
                                {
                                    <option value="@village.VillageId">@village.VillageName</option>
                                }
                            }
                        </select>
                        <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
                    </div>
                    
                    <div class="mb-3">
                        <Label For="housenumber" ResourceKey="HouseNumber" ResourceType="@resourceType" Class="form-label fw-bold">House Number:</Label>
                        <input id="housenumber" class="form-control form-control-lg" @bind="@_houseNumber" />
                    </div>
                    
                    <div class="mb-3">
                        <Label For="idnumber" ResourceKey="IdNumber" ResourceType="@resourceType" Class="form-label fw-bold">ID Number:</Label>
                        <input id="idnumber" class="form-control form-control-lg" @bind="@_idNumber" />
                    </div>
                </div>
            </div>
            </div>
            <!-- Card 2: Household Information -->
            <div class="col-12 col-lg-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">@Localizer["Section.HouseholdInfo"]</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <Label For="birthdate" ResourceKey="BirthDate" ResourceType="@resourceType" Class="form-label fw-bold">Birth Date:</Label>
                            <input id="birthdate" type="date" class="form-control form-control-lg" @bind="@_birthDate" @bind:format="yyyy-MM-dd" />
                            <small class="form-text text-muted">@Localizer["BirthDate.Help"]</small>
                        </div>
                        
                        <div class="mb-3">
                            <Label For="ownshome" ResourceKey="OwnsHome" ResourceType="@resourceType" Class="form-label fw-bold">Do they own their home?</Label>
                            <select id="ownshome" class="form-select form-select-lg" @bind="@_ownsHomeString">
                                <option value="">@Localizer["Select"]</option>
                                <option value="true">@Localizer["Yes"]</option>
                                <option value="false">@Localizer["No"]</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <Label For="householdsize" ResourceKey="HouseholdSize" ResourceType="@resourceType" Class="form-label fw-bold">Household Size: *</Label>
                            <input id="householdsize" type="number" class="form-control form-control-lg" @bind="@_householdSize" required min="1" />
                            <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
                        </div>
                        
                        <div class="mb-3">
                            <Label For="enrollmentdate" ResourceKey="Date" ResourceType="@resourceType" Class="form-label fw-bold">Date:</Label>
                            <input id="enrollmentdate" type="date" class="form-control form-control-lg" @bind="@_enrollmentDate" @bind:format="yyyy-MM-dd" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 mb-3">
            <button type="button" class="btn btn-primary btn-lg" @onclick="NextStep">
                @Localizer["Next"] <i class="bi bi-arrow-right"></i>
            </button>
            <NavLink class="btn btn-outline-secondary" href="@NavigateUrl()">@Localizer["Cancel"]</NavLink>
        </div>
    </form>
</div>

@code {
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Edit;
    public override string Actions => "BasicInfo";
    public override string Title => "Enrollment - Basic Information";
    public override bool UseAdminContainer => false;

    private ElementReference form;
    private bool validated = false;
    private List<Models.Village> _villages;

    private string _treeMentorName;
    private string _growerName;
    private int _villageId;
    private string _houseNumber;
    private string _idNumber;
    private DateTime? _birthDate;
    private string _ownsHomeString = "";
    private int _householdSize = 1;
    private DateTime _enrollmentDate = DateTime.Today;
    private string resourceType;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _treeMentorName = PageState.User.DisplayName;
            resourceType = GetType().AssemblyQualifiedName;

            // Load villages
            _villages = await VillageService.GetVillagesAsync();

            // Initialize or restore draft
            if (StateService.CurrentDraft == null)
            {
                StateService.InitializeDraft(ModuleState.ModuleId);
            }
            else
            {
                // Restore from draft
                _treeMentorName = StateService.CurrentDraft.TreeMentorName ?? PageState.User.DisplayName;
                _growerName = StateService.CurrentDraft.GrowerName;
                _villageId = StateService.CurrentDraft.VillageId;
                _houseNumber = StateService.CurrentDraft.HouseNumber;
                _idNumber = StateService.CurrentDraft.IdNumber;
                _birthDate = StateService.CurrentDraft.BirthDate;
                _ownsHomeString = StateService.CurrentDraft.OwnsHome.ToString().ToLower();
                _householdSize = StateService.CurrentDraft.HouseholdSize;
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error initializing BasicInfo {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.Error"], MessageType.Error);
        }
    }

    private async Task NextStep()
    {
        try
        {
            validated = true;
            var interop = new Oqtane.UI.Interop(JSRuntime);
            if (await interop.FormValid(form))
            {
                // Save to draft state
                StateService.CurrentDraft.TreeMentorName = _treeMentorName;
                StateService.CurrentDraft.GrowerName = _growerName;
                StateService.CurrentDraft.VillageId = _villageId;
                StateService.CurrentDraft.HouseNumber = _houseNumber;
                StateService.CurrentDraft.IdNumber = _idNumber;
                StateService.CurrentDraft.BirthDate = _birthDate;
                StateService.CurrentDraft.OwnsHome = !string.IsNullOrEmpty(_ownsHomeString) && bool.Parse(_ownsHomeString);
                StateService.CurrentDraft.HouseholdSize = _householdSize;

                // Navigate to next step
                NavigationManager.NavigateTo(EditUrl("Criteria"));
            }
            else
            {
                AddModuleMessage(Localizer["Message.ValidationError"], MessageType.Error);
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error in BasicInfo step {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.Error"], MessageType.Error);
        }
    }
}
