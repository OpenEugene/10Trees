@using OpenEug.TenTrees.Module.Enrollment.Services
@using OpenEug.TenTrees.Module.Enrollment.Models
@using Oqtane.Modules.Controls

@namespace OpenEug.TenTrees.Module.Enrollment
@inherits ModuleBase
@inject IEnrollmentService EnrollmentService
@inject IEnrollmentStateService StateService
@inject NavigationManager NavigationManager
@inject IStringLocalizer<BasicInfo> Localizer

<div class="mb-3">
    <h3 class="mb-2">@Localizer["FormTitle"]</h3>
    <p class="text-muted small">@Localizer["Step"] 1 @Localizer["Of"] 4</p>
</div>

<div class="progress mb-3" style="height: 8px;">
    <div class="progress-bar" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
</div>

<form @ref="form" class="@(validated ? " was-validated" : "needs-validation" )" novalidate>
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">@Localizer["Section.BasicInfo"]</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <Label For="evaluatorname" ResourceKey="EvaluatorName" Class="form-label fw-bold">Evaluator Name:</Label>
                <input id="evaluatorname" class="form-control form-control-lg" @bind="@_evaluatorName" readonly />
            </div>
            
            <div class="mb-3">
                <Label For="beneficiaryname" ResourceKey="BeneficiaryName" Class="form-label fw-bold">Beneficiary Name: *</Label>
                <input id="beneficiaryname" class="form-control form-control-lg" @bind="@_beneficiaryName" required />
                <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
            </div>
            
            <div class="mb-3">
                <Label For="villageid" ResourceKey="Village" Class="form-label fw-bold">Village: *</Label>
                <input id="villageid" type="number" class="form-control form-control-lg" @bind="@_villageId" required />
                <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
            </div>
            
            <div class="mb-3">
                <Label For="housenumber" ResourceKey="HouseNumber" Class="form-label fw-bold">House Number:</Label>
                <input id="housenumber" class="form-control form-control-lg" @bind="@_houseNumber" />
            </div>
            
            <div class="mb-3">
                <Label For="idnumber" ResourceKey="IdNumber" Class="form-label fw-bold">ID Number:</Label>
                <input id="idnumber" class="form-control form-control-lg" @bind="@_idNumber" />
            </div>
            
            <div class="mb-3">
                <Label For="birthdate" ResourceKey="BirthDate" Class="form-label fw-bold">Birth Date:</Label>
                <input id="birthdate" type="date" class="form-control form-control-lg" @bind="@_birthDate" />
                <small class="form-text text-muted">@Localizer["BirthDate.Help"]</small>
            </div>
            
            <div class="mb-3">
                <Label For="ownshome" ResourceKey="OwnsHome" Class="form-label fw-bold">Do they own their home?</Label>
                <select id="ownshome" class="form-select form-select-lg" @bind="@_ownsHome">
                    <option value="">@Localizer["Select"]</option>
                    <option value="true">@Localizer["Yes"]</option>
                    <option value="false">@Localizer["No"]</option>
                </select>
            </div>
            
            <div class="mb-3">
                <Label For="householdsize" ResourceKey="HouseholdSize" Class="form-label fw-bold">Household Size: *</Label>
                <input id="householdsize" type="number" class="form-control form-control-lg" @bind="@_householdSize" required min="1" />
                <div class="invalid-feedback">@Localizer["Validation.Required"]</div>
            </div>
            
            <div class="mb-3">
                <Label For="enrollmentdate" ResourceKey="Date" Class="form-label fw-bold">Date:</Label>
                <input id="enrollmentdate" type="date" class="form-control form-control-lg" @bind="@_enrollmentDate" readonly />
            </div>
        </div>
    </div>
    
    <div class="d-grid gap-2 mb-3">
        <button type="button" class="btn btn-primary btn-lg" @onclick="NextStep">
            @Localizer["Next"] <i class="bi bi-arrow-right"></i>
        </button>
        <NavLink class="btn btn-outline-secondary" href="@NavigateUrl()">@Localizer["Cancel"]</NavLink>
    </div>
</form>

@code {
    public override SecurityAccessLevel SecurityAccessLevel => SecurityAccessLevel.Edit;
    public override string Actions => "BasicInfo";
    public override string Title => "Enrollment - Basic Information";
    public override bool UseAdminContainer => false;

    private ElementReference form;
    private bool validated = false;

    private string _evaluatorName;
    private string _beneficiaryName;
    private int _villageId;
    private string _houseNumber;
    private string _idNumber;
    private DateTime? _birthDate;
    private bool _ownsHome;
    private int _householdSize = 1;
    private DateTime _enrollmentDate = DateTime.Today;

    protected override void OnInitialized()
    {
        _evaluatorName = PageState.User.DisplayName;
        
        // Initialize or restore draft
        if (StateService.CurrentDraft == null)
        {
            StateService.InitializeDraft(ModuleState.ModuleId);
        }
        else
        {
            // Restore from draft
            _evaluatorName = StateService.CurrentDraft.EvaluatorName ?? PageState.User.DisplayName;
            _beneficiaryName = StateService.CurrentDraft.BeneficiaryName;
            _villageId = StateService.CurrentDraft.VillageId;
            _houseNumber = StateService.CurrentDraft.HouseNumber;
            _idNumber = StateService.CurrentDraft.IdNumber;
            _birthDate = StateService.CurrentDraft.BirthDate;
            _ownsHome = StateService.CurrentDraft.OwnsHome;
            _householdSize = StateService.CurrentDraft.HouseholdSize;
        }
    }

    private async Task NextStep()
    {
        try
        {
            validated = true;
            var interop = new Oqtane.UI.Interop(JSRuntime);
            if (await interop.FormValid(form))
            {
                // Save to draft state
                StateService.CurrentDraft.EvaluatorName = _evaluatorName;
                StateService.CurrentDraft.BeneficiaryName = _beneficiaryName;
                StateService.CurrentDraft.VillageId = _villageId;
                StateService.CurrentDraft.HouseNumber = _houseNumber;
                StateService.CurrentDraft.IdNumber = _idNumber;
                StateService.CurrentDraft.BirthDate = _birthDate;
                StateService.CurrentDraft.OwnsHome = _ownsHome;
                StateService.CurrentDraft.HouseholdSize = _householdSize;

                // Navigate to next step
                NavigationManager.NavigateTo(EditUrl("Criteria"));
            }
            else
            {
                AddModuleMessage(Localizer["Message.Validation"], MessageType.Warning);
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error in BasicInfo step {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.Error"], MessageType.Error);
        }
    }
}
